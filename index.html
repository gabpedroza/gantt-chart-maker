<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simple Gantt (fixed add + layout)</title>
<style>
  :root{--bg:#fafafa;--card:#fff;--muted:#666}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:18px;color:#111;background:var(--bg)}
  header{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  input,button,select,textarea{font:inherit;padding:6px;border:1px solid #ccc;border-radius:6px}
  .cols{display:grid;grid-template-columns:420px 1fr;gap:16px;align-items:start}
  .card{background:var(--card);border:1px solid #eee;padding:12px;border-radius:8px;box-shadow:0 1px 2px rgba(0,0,0,0.02)}
  table{width:100%;border-collapse:collapse;table-layout:fixed}
  td,th{padding:6px;border-bottom:1px solid #f2f2f2;vertical-align:middle;overflow:hidden}
  .gantt{overflow:auto;border-radius:6px;padding:8px;background:linear-gradient(#fff,#f9f9f9);min-height:520px}
  svg{display:block}
  .small{font-size:13px;color:var(--muted)}
  .controls{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
  .depsel{width:120px}
  .row-actions{display:flex;gap:6px}
  /* Fix: keep new-task row on one line and align with labels */
  .new-task-row{display:flex;gap:6px;align-items:center;flex-wrap:nowrap;margin-top:8px}
  .new-task-row input[type=date]{width:120px}
  .new-task-row input[type=text]{min-width:160px}
  .new-task-row button{white-space:nowrap}
  /* ensure table header aligns with inputs */
  thead th:nth-child(1){width:36%}
  thead th:nth-child(2){width:14%}
  thead th:nth-child(3){width:14%}
  thead th:nth-child(4){width:10%}
  thead th:nth-child(5){width:18%}
  thead th:nth-child(6){width:8%}
</style>
</head>
<body>
<header>
  <h2 style="margin:0">Simple Gantt (fixed)</h2>
  <div class="small">Add task fixed. New-task inputs kept on one line and aligned with table labels.</div>
</header>
<div class="controls">
  <button id="newBtn">New chart</button>
  <button id="genBtn">Get code</button>
  <button id="copyLinkBtn">Copy share link</button>
  <input id="loadCode" placeholder="Paste code and press Load" style="min-width:300px" />
  <button id="loadBtn">Load</button>
  <button id="exportBtn">Export JSON</button>
  <button id="importBtn">Import JSON</button>
  <label class="small">Zoom</label>
  <button id="zoomOut">-</button>
  <button id="zoomIn">+</button>
</div>
<div class="cols">
  <div class="card" style="align-self:start;position:sticky;top:0">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <input id="chartTitle" placeholder="Chart title" style="flex:1" />
      <input id="owner" placeholder="Owner (optional)" style="width:140px" />
    </div>
    <table id="tasksTable">
      <thead><tr><th>Task</th><th>Start</th><th>End</th><th>%</th><th>Depends</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="new-task-row">
      <input id="newTaskName" placeholder="New task name" type="text" />
      <input id="newTaskStart" type="date" />
      <input id="newTaskEnd" type="date" />
      <button id="addTaskBtn">Add</button>
    </div>
  </div>
  <div class="card">
    <div class="small">Gantt preview. Use zoom or resize window. Arrows show dependencies.</div>
    <div class="gantt" id="ganttWrap"><svg id="ganttSVG" width="1600" height="600" xmlns="http://www.w3.org/2000/svg"></svg></div>
  </div>
</div>
<script>
/* Utilities */
function encodeData(obj){const s=JSON.stringify(obj);const b=btoa(unescape(encodeURIComponent(s)));return b.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
function decodeData(code){try{const padded=code + '=='.slice((code.length+3)%4);const b=padded.replace(/-/g,'+').replace(/_/g,'/');const s=decodeURIComponent(escape(atob(b)));return JSON.parse(s);}catch(e){return null}}
function uid(){return Math.random().toString(36).slice(2,9)}
function todayISO(){return new Date().toISOString().slice(0,10)}
function daysBetween(d1,d2){return Math.round((d2-d1)/(24*3600*1000));}
function escapeHtml(s){return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;')}

/* App state */
let state={title:'New chart',owner:'',tasks:[]};
let dayWidth=20; // zoomable
const tasksTbody=document.querySelector('#tasksTable tbody');
const svg=document.getElementById('ganttSVG');

/* Add/Edit tasks */
function addTask(name,start,end,progress,deps){state.tasks.push({id:uid(),name:name||'Task',start:start||todayISO(),end:end||start||todayISO(),progress:progress||0,deps:deps||[],color:randomColor()});saveLocal();renderTasks();renderGantt();}
function randomColor(){const h=Math.floor(Math.random()*360);return `hsl(${h} 70% 60%)`}

function renderTasks(){tasksTbody.innerHTML='';
  state.tasks.forEach(t=>{
    const tr=document.createElement('tr');
    const depsOptions = state.tasks.map(o=>`<option value="${o.id}" ${t.deps && t.deps.includes(o.id) ? 'selected':''}>${escapeHtml(o.name)}</option>`).join('');
    tr.innerHTML=`
      <td><input value="${escapeHtml(t.name)}" data-id="${t.id}" class="tname" style="width:100%"></td>
      <td><input type="date" value="${t.start}" data-id="${t.id}" class="tstart"></td>
      <td><input type="date" value="${t.end}" data-id="${t.id}" class="tend"></td>
      <td><input type="number" min="0" max="100" value="${t.progress||0}" data-id="${t.id}" class="tprog" style="width:64px"></td>
      <td><select multiple class="tdeps" data-id="${t.id}" style="width:120px;height:64px">${depsOptions}</select></td>
      <td class="row-actions"><button data-id="${t.id}" class="del">Del</button></td>`;
    tasksTbody.appendChild(tr);
  });
  attachTaskEvents();
}

function attachTaskEvents(){Array.from(document.querySelectorAll('.tname')).forEach(i=>i.oninput=e=>{const id=e.target.dataset.id;const t=state.tasks.find(x=>x.id===id);if(t){t.name=e.target.value;saveLocal();renderGantt();}});
  Array.from(document.querySelectorAll('.tstart')).forEach(i=>i.onchange=e=>{const id=e.target.dataset.id;const t=state.tasks.find(x=>x.id===id);if(t){t.start=e.target.value;saveLocal();renderGantt();}});
  Array.from(document.querySelectorAll('.tend')).forEach(i=>i.onchange=e=>{const id=e.target.dataset.id;const t=state.tasks.find(x=>x.id===id);if(t){t.end=e.target.value;saveLocal();renderGantt();}});
  Array.from(document.querySelectorAll('.tprog')).forEach(i=>i.oninput=e=>{const id=e.target.dataset.id;const t=state.tasks.find(x=>x.id===id);if(t){t.progress=Number(e.target.value);saveLocal();renderGantt();}});
  Array.from(document.querySelectorAll('.tdeps')).forEach(s=>s.onchange=e=>{const id=s.dataset.id;const t=state.tasks.find(x=>x.id===id);if(t){t.deps = Array.from(s.selectedOptions).map(o=>o.value);saveLocal();renderGantt();}});
  Array.from(document.querySelectorAll('.del')).forEach(b=>b.onclick=e=>{const id=e.target.dataset.id;state.tasks=state.tasks.filter(t=>t.id!==id); state.tasks.forEach(tt=>{if(tt.deps) tt.deps = tt.deps.filter(d=>d!==id)}); saveLocal();renderTasks();renderGantt();});
}

/* Gantt rendering with dependency arrows */
function renderGantt(){if(state.tasks.length===0){svg.setAttribute('width',1000);svg.setAttribute('height',120);svg.innerHTML=`<text x="12" y="40" class="small">No tasks. Add tasks to see the timeline.</text>`;return}
  // compute date range
  const dates=state.tasks.flatMap(t=>[new Date(t.start),new Date(t.end)]);
  let min=new Date(Math.min(...dates.map(d=>d.getTime())));
  let max=new Date(Math.max(...dates.map(d=>d.getTime())));
  min.setDate(min.getDate()-3); max.setDate(max.getDate()+3);
  const totalDays = Math.max(1, daysBetween(min,max));
  const leftPad = 200; const rowH=36; const headerH=28;
  const height = headerH + state.tasks.length*rowH + 80; const width = leftPad + totalDays*dayWidth + 60;
  svg.setAttribute('width',Math.max(900,width)); svg.setAttribute('height',height);

  // defs for arrows
  let s='';
  s+=`<defs><marker id="arrow" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 z" fill="#444"/></marker></defs>`;
  s+=`<style>text{font-family:system-ui;font-size:12px}.muted{fill:#666}</style>`;

  // day columns and labels
  for(let d=0; d<=totalDays; d++){const cur=new Date(min);cur.setDate(min.getDate()+d);const x=leftPad + d*dayWidth; s+=`<text x="${x+4}" y="14" class="muted">${cur.toISOString().slice(5,10)}</text>`; s+=`<rect x="${x}" y="${headerH}" width="${dayWidth}" height="${height-headerH}" fill="transparent" stroke="#eee"/>`;}

  // task bars
  const pos = {}; // task id -> {x,y,w}
  state.tasks.forEach((t,i)=>{
    const rowY = headerH + 8 + i*rowH; const barH=18;
    const startIdx = daysBetween(min,new Date(t.start)); const dur = Math.max(1, daysBetween(new Date(t.start), new Date(t.end)) + 1);
    const x = leftPad + startIdx*dayWidth; const w = Math.max(6, dur*dayWidth);
    pos[t.id] = {x, y: rowY, w, h: barH, i};
    s += `<text x="12" y="${rowY+barH-4}">${escapeHtml(t.name)}</text>`;
    s += `<rect x="${x}" y="${rowY}" rx="4" ry="4" width="${w}" height="${barH}" fill="${t.color}" opacity="0.95" stroke="#333" stroke-opacity="0.06"></rect>`;
    const pw = Math.max(1, Math.round(w * ((t.progress||0)/100)));
    s += `<rect x="${x}" y="${rowY}" width="${pw}" height="${barH}" fill="#000" fill-opacity="0.15"></rect>`;
    s += `<text x="${x + w + 8}" y="${rowY + barH -4}" font-size="11" class="muted">${t.progress||0}%</text>`;
  });

  // dependency arrows
  state.tasks.forEach(t=>{if(t.deps && t.deps.length){t.deps.forEach(did=>{const a=pos[did];const b=pos[t.id];if(a && b){const startX = a.x + a.w; const startY = a.y + a.h/2; const endX = b.x; const endY = b.y + b.h/2; const midX = Math.min(startX + 30, endX - 10);
    s += `<path d="M${startX} ${startY} C ${startX+20} ${startY} ${midX-10} ${endY} ${midX} ${endY} L ${endX} ${endY}" stroke="#444" fill="none" marker-end="url(#arrow)" stroke-width="1.6" opacity="0.9"/>`;
  }})}});

  svg.innerHTML = s;
}

/* Save/Load (code embeds full state including deps) */
function generateCode(){const payload={v:2,title:state.title||'',owner:state.owner||'',tasks:state.tasks};return encodeData(payload)}
function loadFromCode(code){const obj=decodeData(code);if(!obj) {alert('Bad code'); return false;} state.title = obj.title||'Recovered chart'; state.owner = obj.owner||''; state.tasks = obj.tasks || []; saveLocal();document.getElementById('chartTitle').value=state.title;document.getElementById('owner').value=state.owner;renderTasks();renderGantt();return true}

/* Local autosave */
function saveLocal(){try{localStorage.setItem('gantt_local_v2', JSON.stringify(state));}catch(e){}
}
function loadLocal(){try{const s=localStorage.getItem('gantt_local_v2');if(s){state=JSON.parse(s);document.getElementById('chartTitle').value=state.title||'';document.getElementById('owner').value=state.owner||'';renderTasks();renderGantt();return true}}catch(e){}return false}

/* UI wiring */
document.getElementById('addTaskBtn').onclick=()=>{
  const n=document.getElementById('newTaskName').value.trim()||('Task ' + (state.tasks.length+1));
  const s=document.getElementById('newTaskStart').value || todayISO();
  const e=document.getElementById('newTaskEnd').value || s;
  addTask(n,s,e,0,[]);
  document.getElementById('newTaskName').value='';
}

document.getElementById('newBtn').onclick=()=>{state={title:'New chart',owner:'',tasks:[]};saveLocal();document.getElementById('chartTitle').value=state.title;document.getElementById('owner').value='';renderTasks();renderGantt();location.hash='';}

document.getElementById('genBtn').onclick=()=>{const code=generateCode();prompt('Chart code (share this). You can also append it to the site URL as #c=CODE',code)}

document.getElementById('copyLinkBtn').onclick=()=>{const code=generateCode();const link=location.origin + location.pathname + '#c=' + code;navigator.clipboard.writeText(link).then(()=>alert('Link copied to clipboard')).catch(()=>prompt('Copy link', link));}

document.getElementById('loadBtn').onclick=()=>{const c=document.getElementById('loadCode').value.trim();if(!c) return alert('Paste code first');loadFromCode(c)}

document.getElementById('exportBtn').onclick=()=>{const blob=new Blob([JSON.stringify({title:state.title,owner:state.owner,tasks:state.tasks},null,2)],{type:'application/json'});const u=URL.createObjectURL(blob);const a=document.createElement('a');a.href=u;a.download=(state.title||'gantt')+'.json';document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u)}

document.getElementById('importBtn').onclick=()=>{const f=document.createElement('input');f.type='file';f.accept='application/json';f.onchange=()=>{const file=f.files[0];if(!file) return;const r=new FileReader();r.onload=()=>{try{const obj=JSON.parse(r.result);state.title=obj.title||state.title;state.owner=obj.owner||'';state.tasks=obj.tasks||[];document.getElementById('chartTitle').value=state.title;document.getElementById('owner').value=state.owner;saveLocal();renderTasks();renderGantt();}catch(e){alert('Bad file')} };r.readAsText(file)};f.click();}

document.getElementById('chartTitle').oninput=e=>{state.title=e.target.value;saveLocal()}
document.getElementById('owner').oninput=e=>{state.owner=e.target.value;saveLocal()}

// Zoom controls
document.getElementById('zoomIn').onclick=()=>{dayWidth = Math.min(80, dayWidth + 4);renderGantt();}
document.getElementById('zoomOut').onclick=()=>{dayWidth = Math.max(8, dayWidth - 4);renderGantt();}

// init: try URL hash then local
function checkHash(){const h=location.hash.slice(1);if(!h) return false;const m=h.match(/c=([^&]+)/);if(m){const code=m[1];if(loadFromCode(code)){document.getElementById('loadCode').value=code;return true}}return false}

if(!checkHash()){if(!loadLocal()){state={title:'New chart',owner:'',tasks:[{id:uid(),name:'Example task',start:todayISO(),end:todayISO(),progress:0,deps:[],color:randomColor()}]};saveLocal();}}
renderTasks();renderGantt();
</script>
</body>
</html>
